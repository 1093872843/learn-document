## 如何建立https连接

1. 在TCP三次握手的基础上增加了SSL握手
2. 客户端使用https的url访问web服务器,要求与服务器建立ssl连接
3. web服务器收到客户端请求后, 会将网站的证书(包含公钥)传送一份给客户端
4. 客户端收到网站证书后会检查证书的颁发机构以及过期时间, 如果没有问题就随机产生一个秘钥
5. 客户端利用公钥将会话秘钥加密, 并传送给服务端, 服务端利用自己的私钥解密出会话秘钥
6. 之后服务器与客户端使用秘钥加密传输

## https握手过程中，客户端如何验证证书的合法性

一 对称加密

服务端A和客户端使用相同的秘钥来加密传输信息，但这种方式存在了被中间人篡改的风险，也叫做中间人攻击

二 非对称加密

需要一对 公私秘钥，公钥加密，私钥解密。

服务端A 生成自己的公/私秘钥，当客户端B向服务端A请求url时，服务端A发送自己的公钥交给客户端B，客户端B获得这个公钥后，会先自己生成一个对称秘钥，然后使用公钥去加密这个秘钥并发送给服务端A，服务端A获得信息后，使用自己的私钥解密信息，获得秘钥，之后双方通过对称秘钥来发送信息。

但是也有破解手段，如果中间人在通讯开始截取了服务端A发送给客户端的公钥的过程，那么，中间人会使用自己的公/私秘钥代替这次通话，并在AB之间做通讯中转，那么最终中间人将获取到本次会话的秘钥，从而发起攻击。

三 证书机构CA的非对称加密啊

`制作证书`：证书机构也有自己的公/私秘钥。服务端A会将自己的公钥发送给证书机构用于申请证书，证书机构会使用自己的私钥加密服务端A的公钥，然后配合服务端的网址等信息生成一个证书签名，再次私钥加密后发送给A。

`如何校验`：当客户端请求通讯的时候，服务端不再返回自己的公钥，而是返回证书，**因为各大浏览器和操作系统已经维护了所有权威证书机构的名称和公钥**，所以客户端只要知道这个证书来源于哪个证书机构，就是用对应的机构公钥解密证书签名。接下来，客户端拿到服务端的公钥和网址后，就以同样的规则用自己访问的网址和这个公钥再次生成签名证书去对比是否和接收到的证书一致。如一致，说明该证书有效。

签名验证成功后，B就可以再次利用机构的公钥，解密出A的公钥，接下来的操作，就和二的非对称加密一致了。

因为证书的签名是通过服务器端网址等信息生成的，中间人没有机会介入，中间人的网址和服务端不同，无法通过客户端B的验证。

我曾是菜鸟的白痴时想的问题

1.既然中间人可以劫持第一步，为什么不能劫持最后一步直接获取通讯秘钥。

中间人劫持并不是直接凭控劫持，而是通过诱导欺骗或是伪装成某个网站，使得用户误以为自己在正常操作。但实际上，用户访问的是攻击者指定的中间网站。

2.劫持证书不行吗？

不行，客户端验证会用正在访问的网址和得到的服务端公钥去生成新的证书来对比，如果是中间人攻击，中贱人网址是和服务端网址是不一致的。
